<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FFmpeg 0.12.15 Simple Video Converter Test</title>
</head>
<body>
  <h1>FFmpeg 0.12.15 Simple Video Converter Test</h1>
  <input type="file" id="uploader" accept="video/*" />
  <br /><br />
  <label for="outputFormat">Choose output format:</label>
  <select id="outputFormat">
    <option value="mp4">MP4</option>
    <option value="webm">WEBM</option>
    <option value="gif">GIF</option>
  </select>
  <br /><br />
  <button id="convertBtn">Convert</button>
  <br /><br />
  <video id="videoOutput" controls style="max-width: 400px;"></video>
  <script type="module">
    import { FFmpeg } from './assets/ffmpeg/ffmpeg.min.js';

    const ffmpeg = new FFmpeg();
    const uploader = document.getElementById('uploader');
    const convertBtn = document.getElementById('convertBtn');
    const outputFormatSelect = document.getElementById('outputFormat');
    const videoOutput = document.getElementById('videoOutput');

    let inputFile = null;

    uploader.addEventListener('change', (e) => {
      inputFile = e.target.files[0];
      console.log('File selected:', inputFile ? inputFile.name : 'None');
    });

    convertBtn.addEventListener('click', async () => {
      if (!inputFile) {
        alert('Please select a video file first.');
        return;
      }

      const outputFormat = outputFormatSelect.value;
      console.log('Starting conversion to format:', outputFormat);

      try {
        console.log('Loading FFmpeg core...');
        await ffmpeg.load();
        console.log('FFmpeg loaded successfully.');

        const fileName = 'input.' + inputFile.name.split('.').pop();
        const outputFileName = 'output.' + outputFormat;

        const data = await inputFile.arrayBuffer();
        console.log('Writing file to FFmpeg FS:', fileName);
        await ffmpeg.writeFile(fileName, new Uint8Array(data));
        console.log('File written.');

        // Build ffmpeg command arguments
        // Basic example: convert input to output format, keeping video codec copy for speed
        const args = ['-i', fileName];

        if (outputFormat === 'gif') {
          args.push('-t', '5'); // limit gif length to 5 seconds for demo
        }

        args.push(outputFileName);

        console.log('Running FFmpeg with args:', args);
        await ffmpeg.exec(args);
        console.log('FFmpeg command finished.');

        console.log('Reading output file:', outputFileName);
        const outputData = await ffmpeg.readFile(outputFileName);

        // Create blob and object URL for output video/gif
        const blob = new Blob([outputData.buffer], { type: 'video/' + (outputFormat === 'gif' ? 'gif' : outputFormat) });
        const url = URL.createObjectURL(blob);
        videoOutput.src = url;
        console.log('Conversion complete! Output video set.');

      } catch (err) {
        console.error('Error during conversion:', err);
        alert('Conversion failed. Check console for details.');
      }
    });
  </script>
</body>
</html>
