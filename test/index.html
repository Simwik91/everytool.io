<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>FFmpeg WASM Video Converter - Full In-Browser Example</title>
<style>
  body { font-family: sans-serif; max-width: 600px; margin: 2em auto; }
  progress { width: 100%; height: 20px; }
  #downloadLink { display: none; margin-top: 1em; }
</style>
</head>
<body>

<h1>FFmpeg WASM Video Converter</h1>

<input type="file" id="uploader" accept="video/*" />
<br /><br />
<button id="convertBtn" disabled>Convert to WebM</button>

<progress id="progressBar" max="100" value="0"></progress>
<div id="status">Awaiting file upload...</div>
<a id="downloadLink" href="#" download="output.webm">Download Converted Video</a>

<script type="module">
  import { FFmpeg } from '/assets/ffmpeg/ffmpeg.min.js'; // Adjust path as needed

  const uploader = document.getElementById('uploader');
  const convertBtn = document.getElementById('convertBtn');
  const status = document.getElementById('status');
  const progressBar = document.getElementById('progressBar');
  const downloadLink = document.getElementById('downloadLink');

  const ffmpeg = new FFmpeg({
    log: true,
    progress: ({ ratio }) => {
      const percent = Math.round(ratio * 100);
      progressBar.value = percent;
      status.textContent = `Converting... ${percent}%`;
    }
  });

  let inputFileName = '';
  let inputFileData = null;

  uploader.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    inputFileName = file.name;
    status.textContent = `Loading file "${inputFileName}"...`;
    progressBar.value = 0;
    downloadLink.style.display = 'none';
    convertBtn.disabled = true;

    inputFileData = new Uint8Array(await file.arrayBuffer());

    status.textContent = `File loaded: ${inputFileName} (${(inputFileData.length/1024).toFixed(1)} KB)`;

    convertBtn.disabled = false;
  });

  convertBtn.addEventListener('click', async () => {
    convertBtn.disabled = true;
    status.textContent = 'Loading FFmpeg core...';
    progressBar.value = 0;
    downloadLink.style.display = 'none';

    try {
      await ffmpeg.load({
        corePath: '/assets/ffmpeg/ffmpeg-core.wasm',
        workerPath: '/assets/ffmpeg/ffmpeg-core.js',
      });
      status.textContent = 'FFmpeg loaded. Writing file to FS...';

      // Write the uploaded file to FFmpeg FS
      await ffmpeg.writeFile(inputFileName, inputFileData);

      status.textContent = 'Starting conversion...';
      progressBar.value = 0;

      // Convert input video to output.webm
      await ffmpeg.exec(['-i', inputFileName, '-c:v', 'libvpx', '-b:v', '1M', 'output.webm']);

      status.textContent = 'Conversion finished! Preparing download...';

      // Read converted file from FS
      const outputData = await ffmpeg.readFile('output.webm');

      // Create Blob and Object URL for download
      const videoBlob = new Blob([outputData], { type: 'video/webm' });
      const videoUrl = URL.createObjectURL(videoBlob);

      downloadLink.href = videoUrl;
      downloadLink.style.display = 'inline-block';

      status.textContent = 'Conversion complete! Click below to download your video.';
    } catch (err) {
      console.error(err);
      status.textContent = 'Error: ' + err.message;
    } finally {
      convertBtn.disabled = false;
      progressBar.value = 0;
    }
  });
</script>

</body>
</html>
