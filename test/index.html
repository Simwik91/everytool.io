<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FFmpeg WASM Test</title>
</head>
<body>
  <h1>FFmpeg WASM Video Converter Test</h1>
  <input type="file" id="uploader" />
  <button id="convertBtn" disabled>Convert to mp4</button>
  <pre id="log"></pre>

  <script src="https://everytool.io/assets/ffmpeg/ffmpeg.min.js"></script>
  <script>
    const logEl = document.getElementById('log');
    const uploader = document.getElementById('uploader');
    const convertBtn = document.getElementById('convertBtn');

    function log(msg) {
      console.log(msg);
      logEl.textContent += msg + '\n';
    }

    // Make sure FFmpeg is available
    if (!window.FFmpeg) {
      log('FFmpeg object not found!');
    } else {
      log('FFmpeg object loaded.');
    }

    // Create FFmpeg instance with paths set explicitly
    const ffmpeg = FFmpeg.createFFmpeg({
      log: true,
      corePath: 'https://everytool.io/assets/ffmpeg/ffmpeg-core.js', // core js path
      wasmPath: 'https://everytool.io/assets/ffmpeg/ffmpeg-core.wasm' // core wasm path
    });

    async function loadFFmpeg() {
      log('Loading FFmpeg core...');
      try {
        await ffmpeg.load();
        log('FFmpeg loaded successfully!');
        convertBtn.disabled = false;
      } catch (e) {
        log('FFmpeg load error: ' + e.message);
      }
    }

    loadFFmpeg();

    convertBtn.addEventListener('click', async () => {
      if (uploader.files.length === 0) {
        log('No file selected');
        return;
      }

      const file = uploader.files[0];
      log(`Input file: ${file.name}`);

      // Write the uploaded file to FFmpeg FS
      try {
        const data = await file.arrayBuffer();
        ffmpeg.FS('writeFile', file.name, new Uint8Array(data));
        log('File written to FFmpeg FS');

        // Run FFmpeg conversion command - convert input to mp4
        await ffmpeg.run('-i', file.name, 'output.mp4');
        log('FFmpeg conversion finished');

        // Read output file from FS
        const outputData = ffmpeg.FS('readFile', 'output.mp4');

        // Create a Blob and download link
        const blob = new Blob([outputData.buffer], { type: 'video/mp4' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'output.mp4';
        a.textContent = 'Download converted video';
        document.body.appendChild(a);

        log('Output file ready for download');
      } catch (err) {
        log('Error during conversion: ' + err.message);
      }
    });
  </script>
</body>
</html>
