<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Image Toolkit - EveryTool.io</title>
  
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --border-radius: 12px;
      --box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, var(--light) 0%, #f0f4ff 100%);
      color: var(--dark);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* Header */
    header {
      background: white;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
    }

    .logo {
      display: flex;
      align-items: center;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      text-decoration: none;
    }

    .logo i {
      margin-right: 10px;
      font-size: 2.2rem;
    }

    /* Hero Section */
    .hero {
      padding: 40px 0 20px;
      text-align: center;
    }

    .hero h1 {
      font-size: 2rem;
      margin-bottom: 15px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--primary), #7209b7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.2;
    }

    .hero p {
      font-size: 1.1rem;
      color: var(--gray);
      margin-bottom: 30px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .card {
      background: var(--light);
      border-radius: var(--border-radius);
      box-shadow: var(--box-shadow);
      padding: 20px;
      margin-bottom: 20px;
      transition: var(--transition);
    }
    
    h2 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: var(--dark);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
    }
    
    h2 i {
      color: var(--primary);
    }
    
    /* Unified Toolbar */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 15px;
      justify-content: center;
    }
    
    .tool-btn {
      padding: 10px 15px;
      border-radius: 8px;
      background: var(--light-gray);
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
      font-size: 0.9rem;
    }
    
    .tool-btn.active, .tool-btn:hover {
      background: var(--primary);
      color: white;
    }
    
    /* Controls */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    .control-group label {
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 0.9rem;
    }
    
    input, select, button, textarea {
      margin: 0.5em auto;
      padding: 12px;
      width: 100%;
      font-size: 0.9rem;
      border-radius: 8px;
      border: 1px solid var(--light-gray);
      background: var(--light);
      display: block;
      transition: var(--transition);
      font-family: 'Poppins', sans-serif;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }
    
    button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      padding: 12px 15px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    button:hover, button:focus {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    button:disabled {
      background: #9ec5e6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    canvas {
      margin: 1.5em auto;
      max-width: 100%;
      border-radius: 12px;
      background: #f5f5f5;
      padding: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--light-gray);
      display: block;
    }
    
    .drag-drop-area {
      width: 100%;
      max-width: 500px;
      margin: 1.5em auto;
      padding: 1.5em;
      border: 2px dashed var(--light-gray);
      border-radius: var(--border-radius);
      background: white;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-size: 0.9rem;
    }

    .drag-drop-area.drag-over {
      background: #e6f0fa;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .drag-drop-area p {
      margin: 0.5em 0;
    }
    
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 1.5em 0;
      flex-wrap: wrap;
    }
    
    .btn-group button {
      width: auto;
      min-width: 150px;
      flex: 1;
    }
    
    .error {
      color: #e74c3c;
      padding: 12px;
      background: rgba(231, 76, 60, 0.1);
      border-radius: var(--border-radius);
      margin: 15px 0;
      display: none;
      border-left: 4px solid #e74c3c;
      font-size: 0.9rem;
    }
    
    .success {
      color: #27ae60;
      padding: 12px;
      background: rgba(39, 174, 96, 0.1);
      border-radius: var(--border-radius);
      margin: 15px 0;
      display: none;
      border-left: 4px solid #27ae60;
      font-size: 0.9rem;
    }
    
    .loading {
      display: none;
      text-align: center;
      padding: 20px;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* History Controls */
    .history-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 15px 0;
    }
    
    .history-btn {
      padding: 10px 15px;
      border-radius: 50px;
      background: var(--light-gray);
      border: none;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    .history-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Footer */
    footer {
      background: linear-gradient(135deg, var(--light) 0%, #f0f4ff 100%);
      color: #000;
      padding: 40px 0 20px;
    }

    .footer-bottom {
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      padding-top: 20px;
      text-align: center;
    }

    .footer-bottom a {
      color: #000;
      text-decoration: none;
      transition: var(--transition);
      font-weight: 600;
      font-size: 1rem;
      margin: 0 8px;
    }

    .footer-bottom a:hover, .footer-bottom a:focus {
      color: var(--primary);
      text-decoration: underline;
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .footer-links-row {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .footer-bottom p {
      color: #000;
      font-weight: 600;
      font-size: 1rem;
      margin: 0;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .hero h1 {
        font-size: 1.8rem;
      }
      
      .hero p {
        font-size: 1rem;
      }
      
      .toolbar {
        gap: 6px;
      }
      
      .tool-btn {
        padding: 8px 12px;
        font-size: 0.85rem;
      }
      
      .controls {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      canvas {
        padding: 8px;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn-group button {
        width: 100%;
      }
    }

    @media (max-width: 480px) {
      .logo {
        font-size: 1.4rem;
      }
      
      .logo i {
        font-size: 1.6rem;
      }
      
      .hero {
        padding: 30px 0 15px;
      }
      
      .hero h1 {
        font-size: 1.6rem;
      }
      
      .card {
        padding: 15px;
      }
      
      h2 {
        font-size: 1.3rem;
      }
      
      .drag-drop-area {
        padding: 1em;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="header-container">
        <a href="https://everytool.io/" class="logo" aria-label="EveryTool.io Home">
          <i class="fas fa-tools"></i>
          EveryTool.io
        </a>
      </div>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="container">
      <h1>Advanced Image Toolkit</h1>
      <p>Crop, resize, enhance, and draw on images. All processing happens in your browser - your images never leave your device.</p>
    </div>
  </section>

  <div class="container">
    <div class="card">
      <h2><i class="fas fa-edit"></i> Image Editor</h2>
      
      <!-- Unified Toolbar -->
      <div class="toolbar">
        <button class="tool-btn active" id="uploadBtn">
          <i class="fas fa-upload"></i> Upload
        </button>
        <button class="tool-btn" id="cropBtn">
          <i class="fas fa-crop"></i> Crop
        </button>
        <button class="tool-btn" id="resizeBtn">
          <i class="fas fa-expand"></i> Resize
        </button>
        <button class="tool-btn" id="enhanceBtn">
          <i class="fas fa-sliders-h"></i> Enhance
        </button>
        <button class="tool-btn" id="drawBtn">
          <i class="fas fa-paint-brush"></i> Draw
        </button>
      </div>

      <!-- Drag & Drop Area -->
      <div class="drag-drop-area" id="dragArea">
        <p><i class="fas fa-upload"></i> Choose file or drag and drop here</p>
        <p>Supported formats: PNG, JPEG, WEBP, BMP, GIF</p>
        <p>Max file size: 10MB</p>
      </div>
      <input type="file" id="fileUpload" accept="image/*" style="display: none;" />
      
      <!-- Transform Controls -->
      <div class="toolbar">
        <button class="tool-btn" id="rotateLeft">
          <i class="fas fa-undo"></i> Rotate Left
        </button>
        <button class="tool-btn" id="rotateRight">
          <i class="fas fa-redo"></i> Rotate Right
        </button>
        <button class="tool-btn" id="flipHorizontal">
          <i class="fas fa-arrows-alt-h"></i> Flip H
        </button>
        <button class="tool-btn" id="flipVertical">
          <i class="fas fa-arrows-alt-v"></i> Flip V
        </button>
      </div>
      
      <!-- History Controls -->
      <div class="history-controls">
        <button class="history-btn" id="undoBtn" disabled>
          <i class="fas fa-undo"></i> Undo
        </button>
        <button class="history-btn" id="redoBtn" disabled>
          <i class="fas fa-redo"></i> Redo
        </button>
      </div>
      
      <!-- Crop Controls -->
      <div class="controls" id="cropControls" style="display: none;">
        <div class="control-group">
          <label for="cropWidth">Width (px):</label>
          <input type="number" id="cropWidth" min="1" placeholder="Width">
        </div>
        <div class="control-group">
          <label for="cropHeight">Height (px):</label>
          <input type="number" id="cropHeight" min="1" placeholder="Height">
        </div>
        <button id="applyCrop">
          <i class="fas fa-crop"></i> Apply Crop
        </button>
      </div>
      
      <!-- Resize Controls -->
      <div class="controls" id="resizeControls" style="display: none;">
        <div class="control-group">
          <label for="resizeWidth">Width (px):</label>
          <input type="number" id="resizeWidth" min="1" placeholder="Width">
        </div>
        <div class="control-group">
          <label for="resizeHeight">Height (px):</label>
          <input type="number" id="resizeHeight" min="1" placeholder="Height">
        </div>
        <button id="applyResize">
          <i class="fas fa-expand"></i> Apply Resize
        </button>
      </div>
      
      <!-- Enhance Controls -->
      <div class="controls" id="enhanceControls" style="display: none;">
        <div class="control-group">
          <label for="brightness">Brightness</label>
          <input type="range" id="brightness" min="-100" max="100" value="0">
        </div>
        <div class="control-group">
          <label for="contrast">Contrast</label>
          <input type="range" id="contrast" min="-100" max="100" value="0">
        </div>
        <div class="control-group">
          <label for="saturation">Saturation</label>
          <input type="range" id="saturation" min="-100" max="100" value="0">
        </div>
        <button id="applyEnhance">
          <i class="fas fa-magic"></i> Apply Enhancements
        </button>
      </div>
      
      <!-- Draw Controls -->
      <div class="controls" id="drawControls" style="display: none;">
        <div class="control-group">
          <label for="drawColor">Color:</label>
          <input type="color" id="drawColor" value="#FF0000">
        </div>
        <div class="control-group">
          <label for="drawSize">Size:</label>
          <input type="range" id="drawSize" min="1" max="50" value="5">
        </div>
        <button id="saveDrawing">
          <i class="fas fa-save"></i> Save Drawing
        </button>
      </div>
      
      <!-- Canvas Area -->
      <div class="error" id="editorError"></div>
      <div class="success" id="editorSuccess"></div>
      <div class="loading" id="editorLoading">
        <div class="spinner"></div>
        Processing Image...
      </div>
      <canvas id="editorCanvas" width="300" height="200"></canvas>
      
      <!-- Action Buttons -->
      <div class="btn-group">
        <button id="resetBtn">
          <i class="fas fa-undo"></i> Reset
        </button>
        <button id="downloadBtn" style="display: none;">
          <i class="fas fa-download"></i> Download
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-bottom">
        <div class="footer-links-row">
          <a href="/privacy" aria-label="Privacy Policy">Privacy</a>
          <a href="/terms" aria-label="Terms of Service">Terms</a>
          <a href="/about" aria-label="About">About</a>
          <a href="/contact" aria-label="Contact">Contact</a>
        </div>
        <p>Â© 2025 EveryTool.io. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <script>
    // State management
    const state = {
      originalImage: null,
      currentImage: null,
      history: [],
      currentHistoryIndex: -1,
      currentTool: 'upload',
      isDrawing: false,
      lastX: 0,
      lastY: 0
    };

    // DOM Elements
    const canvas = document.getElementById('editorCanvas');
    const ctx = canvas.getContext('2d');
    const dragArea = document.getElementById('dragArea');
    const fileUpload = document.getElementById('fileUpload');
    const downloadBtn = document.getElementById('downloadBtn');
    const resetBtn = document.getElementById('resetBtn');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const errorDiv = document.getElementById('editorError');
    const successDiv = document.getElementById('editorSuccess');
    const loadingDiv = document.getElementById('editorLoading');
    
    // Tool buttons
    const toolButtons = {
      upload: document.getElementById('uploadBtn'),
      crop: document.getElementById('cropBtn'),
      resize: document.getElementById('resizeBtn'),
      enhance: document.getElementById('enhanceBtn'),
      draw: document.getElementById('drawBtn')
    };
    
    // Control sections
    const controlSections = {
      crop: document.getElementById('cropControls'),
      resize: document.getElementById('resizeControls'),
      enhance: document.getElementById('enhanceControls'),
      draw: document.getElementById('drawControls')
    };
    
    // Helper Functions
    function showError(message) {
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      successDiv.style.display = 'none';
    }

    function showSuccess(message) {
      successDiv.textContent = message;
      successDiv.style.display = 'block';
      errorDiv.style.display = 'none';
    }

    function hideMessages() {
      errorDiv.style.display = 'none';
      successDiv.style.display = 'none';
    }

    function showLoading() {
      loadingDiv.style.display = 'block';
    }

    function hideLoading() {
      loadingDiv.style.display = 'none';
    }

    function updateHistoryButtons() {
      undoBtn.disabled = state.currentHistoryIndex <= 0;
      redoBtn.disabled = state.currentHistoryIndex >= state.history.length - 1;
    }

    function saveToHistory() {
      // Remove any future states if we're not at the end
      state.history = state.history.slice(0, state.currentHistoryIndex + 1);
      
      // Save current canvas state
      state.history.push(canvas.toDataURL());
      state.currentHistoryIndex = state.history.length - 1;
      
      updateHistoryButtons();
    }

    function loadFromHistory(index) {
      const img = new Image();
      img.onload = () => {
        drawImageOnCanvas(img);
        state.currentImage = img;
        state.currentHistoryIndex = index;
        updateHistoryButtons();
      };
      img.src = state.history[index];
    }

    function drawImageOnCanvas(image) {
      if (!image) return;
      
      const maxWidth = Math.min(window.innerWidth * 0.9, 800);
      const scale = Math.min(maxWidth / image.width, 1);
      const pixelRatio = window.devicePixelRatio || 1;

      canvas.style.width = `${image.width * scale}px`;
      canvas.style.height = `${image.height * scale}px`;
      canvas.width = image.width * scale * pixelRatio;
      canvas.height = image.height * scale * pixelRatio;
      ctx.scale(pixelRatio, pixelRatio);

      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(image, 0, 0, canvas.width / pixelRatio, canvas.height / pixelRatio);
    }

    function rotateImage(degrees) {
      if (!state.currentImage) return;
      
      const tempCanvas = document.createElement('canvas');
      const tempCtx = tempCanvas.getContext('2d');
      
      if (degrees % 180 === 0) {
        tempCanvas.width = state.currentImage.width;
        tempCanvas.height = state.currentImage.height;
      } else {
        tempCanvas.width = state.currentImage.height;
        tempCanvas.height = state.currentImage.width;
      }
      
      tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
      tempCtx.rotate(degrees * Math.PI / 180);
      tempCtx.drawImage(state.currentImage, -state.currentImage.width / 2, -state.currentImage.height / 2);
      
      const rotated = new Image();
      rotated.src = tempCanvas.toDataURL();
      rotated.onload = () => {
        state.currentImage = rotated;
        drawImageOnCanvas(rotated);
        saveToHistory();
        showSuccess('Image rotated successfully!');
      };
    }

    function flipImage(direction) {
      if (!state.currentImage) return;
      
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = state.currentImage.width;
      tempCanvas.height = state.currentImage.height;
      const tempCtx = tempCanvas.getContext('2d');
      
      if (direction === 'horizontal') {
        tempCtx.translate(state.currentImage.width, 0);
        tempCtx.scale(-1, 1);
      } else {
        tempCtx.translate(0, state.currentImage.height);
        tempCtx.scale(1, -1);
      }
      
      tempCtx.drawImage(state.currentImage, 0, 0);
      
      const flipped = new Image();
      flipped.src = tempCanvas.toDataURL();
      flipped.onload = () => {
        state.currentImage = flipped;
        drawImageOnCanvas(flipped);
        saveToHistory();
        showSuccess('Image flipped successfully!');
      };
    }

    function setActiveTool(tool) {
      // Update UI
      Object.values(toolButtons).forEach(btn => btn.classList.remove('active'));
      toolButtons[tool].classList.add('active');
      
      // Show/hide controls
      Object.values(controlSections).forEach(section => section.style.display = 'none');
      if (controlSections[tool]) {
        controlSections[tool].style.display = 'grid';
      }
      
      state.currentTool = tool;
    }

    // Event Listeners
    dragArea.addEventListener('click', () => fileUpload.click());
    dragArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      dragArea.classList.add('drag-over');
    });
    dragArea.addEventListener('dragleave', () => {
      dragArea.classList.remove('drag-over');
    });
    dragArea.addEventListener('drop', (e) => {
      e.preventDefault();
      dragArea.classList.remove('drag-over');
      if (e.dataTransfer.files.length > 0) {
        fileUpload.files = e.dataTransfer.files;
        handleFileUpload();
      }
    });

    fileUpload.addEventListener('change', handleFileUpload);

    function handleFileUpload() {
      const file = fileUpload.files[0];
      if (!file) return;
      
      hideMessages();
      showLoading();
      
      // Check file type and size
      const fileType = file.type.toLowerCase();
      if (!fileType.match(/image\/(png|jpeg|jpg|webp|bmp|gif)/)) {
        hideLoading();
        showError('Invalid file type. Please upload a valid image (PNG, JPEG, WEBP, BMP, or GIF).');
        return;
      }

      if (file.size > 10 * 1024 * 1024) {
        hideLoading();
        showError('File size exceeds 10MB limit. Please select a smaller file.');
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
          state.originalImage = img;
          state.currentImage = img;
          drawImageOnCanvas(img);
          downloadBtn.style.display = 'inline-block';
          hideLoading();
          showSuccess('Image loaded successfully!');
          saveToHistory();
          setActiveTool('crop');
        };
        img.onerror = () => {
          hideLoading();
          showError('Failed to load image');
        };
        img.src = e.target.result;
      };
      reader.onerror = () => {
        hideLoading();
        showError('Failed to read image file');
      };
      reader.readAsDataURL(file);
    }

    // Tool selection
    Object.keys(toolButtons).forEach(tool => {
      toolButtons[tool].addEventListener('click', () => setActiveTool(tool));
    });

    // Transform controls
    document.getElementById('rotateLeft').addEventListener('click', () => rotateImage(-90));
    document.getElementById('rotateRight').addEventListener('click', () => rotateImage(90));
    document.getElementById('flipHorizontal').addEventListener('click', () => flipImage('horizontal'));
    document.getElementById('flipVertical').addEventListener('click', () => flipImage('vertical'));
    
    // History controls
    undoBtn.addEventListener('click', () => {
      if (state.currentHistoryIndex > 0) {
        loadFromHistory(state.currentHistoryIndex - 1);
      }
    });
    
    redoBtn.addEventListener('click', () => {
      if (state.currentHistoryIndex < state.history.length - 1) {
        loadFromHistory(state.currentHistoryIndex + 1);
      }
    });
    
    // Crop functionality
    document.getElementById('applyCrop').addEventListener('click', () => {
      if (!state.currentImage) {
        showError('Please upload an image first.');
        return;
      }
      
      const width = parseInt(document.getElementById('cropWidth').value);
      const height = parseInt(document.getElementById('cropHeight').value);
      
      if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
        showError('Please enter valid width and height values.');
        return;
      }
      
      showLoading();
      
      setTimeout(() => {
        try {
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = width;
          tempCanvas.height = height;
          const tempCtx = tempCanvas.getContext('2d');
          
          // Center the crop
          const x = (state.currentImage.width - width) / 2;
          const y = (state.currentImage.height - height) / 2;
          
          tempCtx.drawImage(
            state.currentImage, 
            Math.max(0, x), 
            Math.max(0, y), 
            Math.min(width, state.currentImage.width), 
            Math.min(height, state.currentImage.height),
            0, 
            0, 
            width, 
            height
          );
          
          const cropped = new Image();
          cropped.src = tempCanvas.toDataURL();
          cropped.onload = () => {
            state.currentImage = cropped;
            drawImageOnCanvas(cropped);
            saveToHistory();
            hideLoading();
            showSuccess('Image cropped successfully!');
          };
        } catch (err) {
          hideLoading();
          showError('Error cropping image: ' + err.message);
        }
      }, 300);
    });
    
    // Resize functionality
    document.getElementById('applyResize').addEventListener('click', () => {
      if (!state.currentImage) {
        showError('Please upload an image first.');
        return;
      }
      
      const width = parseInt(document.getElementById('resizeWidth').value);
      const height = parseInt(document.getElementById('resizeHeight').value);
      
      if (isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
        showError('Please enter valid width and height values.');
        return;
      }
      
      showLoading();
      
      setTimeout(() => {
        try {
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = width;
          tempCanvas.height = height;
          const tempCtx = tempCanvas.getContext('2d');
          
          tempCtx.drawImage(state.currentImage, 0, 0, width, height);
          
          const resized = new Image();
          resized.src = tempCanvas.toDataURL();
          resized.onload = () => {
            state.currentImage = resized;
            drawImageOnCanvas(resized);
            saveToHistory();
            hideLoading();
            showSuccess('Image resized successfully!');
          };
        } catch (err) {
          hideLoading();
          showError('Error resizing image: ' + err.message);
        }
      }, 300);
    });
    
    // Enhance functionality
    document.getElementById('applyEnhance').addEventListener('click', () => {
      if (!state.currentImage) {
        showError('Please upload an image first.');
        return;
      }
      
      showLoading();
      
      setTimeout(() => {
        try {
          const brightness = parseInt(document.getElementById('brightness').value);
          const contrast = parseInt(document.getElementById('contrast').value);
          const saturation = parseInt(document.getElementById('saturation').value);
          
          const tempCanvas = document.createElement('canvas');
          tempCanvas.width = state.currentImage.width;
          tempCanvas.height = state.currentImage.height;
          const tempCtx = tempCanvas.getContext('2d');
          tempCtx.drawImage(state.currentImage, 0, 0);
          
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          
          // Apply brightness
          for (let i = 0; i < data.length; i += 4) {
            data[i] = clamp(data[i] + brightness);
            data[i+1] = clamp(data[i+1] + brightness);
            data[i+2] = clamp(data[i+2] + brightness);
          }
          
          // Apply contrast
          const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
          for (let i = 0; i < data.length; i += 4) {
            data[i] = clamp(factor * (data[i] - 128) + 128);
            data[i+1] = clamp(factor * (data[i+1] - 128) + 128);
            data[i+2] = clamp(factor * (data[i+2] - 128) + 128);
          }
          
          tempCtx.putImageData(imageData, 0, 0);
          
          const enhanced = new Image();
          enhanced.src = tempCanvas.toDataURL();
          enhanced.onload = () => {
            state.currentImage = enhanced;
            drawImageOnCanvas(enhanced);
            saveToHistory();
            hideLoading();
            showSuccess('Enhancements applied successfully!');
          };
        } catch (err) {
          hideLoading();
          showError('Error enhancing image: ' + err.message);
        }
      }, 300);
    });
    
    // Drawing functionality
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    
    // Touch events for mobile
    canvas.addEventListener('touchstart', handleTouchStart);
    canvas.addEventListener('touchmove', handleTouchMove);
    canvas.addEventListener('touchend', stopDrawing);
    
    function handleTouchStart(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }
    
    function handleTouchMove(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    }
    
    function startDrawing(e) {
      if (state.currentTool !== 'draw' || !state.currentImage) return;
      
      state.isDrawing = true;
      const rect = canvas.getBoundingClientRect();
      state.lastX = e.clientX - rect.left;
      state.lastY = e.clientY - rect.top;
    }
    
    function draw(e) {
      if (!state.isDrawing) return;
      
      const rect = canvas.getBoundingClientRect();
      const currentX = e.clientX - rect.left;
      const currentY = e.clientY - rect.top;
      
      ctx.strokeStyle = document.getElementById('drawColor').value;
      ctx.lineWidth = document.getElementById('drawSize').value;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      
      ctx.beginPath();
      ctx.moveTo(state.lastX, state.lastY);
      ctx.lineTo(currentX, currentY);
      ctx.stroke();
      
      state.lastX = currentX;
      state.lastY = currentY;
    }
    
    function stopDrawing() {
      state.isDrawing = false;
      saveToHistory();
    }
    
    document.getElementById('saveDrawing').addEventListener('click', () => {
      saveToHistory();
      showSuccess('Drawing saved!');
    });
    
    // Reset and download
    resetBtn.addEventListener('click', () => {
      if (confirm('Reset the image? This will clear all edits.')) {
        if (state.originalImage) {
          state.currentImage = state.originalImage;
          drawImageOnCanvas(state.originalImage);
          saveToHistory();
          showSuccess('Image reset successfully!');
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          downloadBtn.style.display = 'none';
        }
      }
    });
    
    downloadBtn.addEventListener('click', () => {
      if (state.currentImage) {
        const link = document.createElement('a');
        link.download = 'edited-image.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        URL.revokeObjectURL(link.href);
        showSuccess('Image downloaded successfully!');
      } else {
        showError('No image available for download.');
      }
    });
    
    // Utility function
    function clamp(value) {
      return Math.max(0, Math.min(255, value));
    }
    
    // Initialize
    setActiveTool('upload');
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
</body>
</html>
