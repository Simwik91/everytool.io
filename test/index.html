<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Simple FFmpeg Converter</title>
</head>
<body>
  <h1>Simple FFmpeg Video Converter</h1>

  <input type="file" id="uploader" accept="video/*" />
  <select id="outputFormat">
    <option value="mp4">MP4</option>
    <option value="webm">WEBM</option>
    <option value="gif">GIF</option>
  </select>
  <button id="convertBtn">Convert</button>
  <br /><br />
  <video id="videoOutput" controls style="max-width: 400px;"></video>

  <!-- UMD Script -->
  <script src="/assets/ffmpeg/ffmpeg.min.js"></script>
  <script>
    const ffmpeg = FFmpeg.createFFmpeg({
      log: true,
      corePath: '/assets/ffmpeg/ffmpeg-core.js',
    });

    const uploader = document.getElementById('uploader');
    const convertBtn = document.getElementById('convertBtn');
    const outputFormatSelect = document.getElementById('outputFormat');
    const videoOutput = document.getElementById('videoOutput');

    let inputFile = null;

    uploader.addEventListener('change', (e) => {
      inputFile = e.target.files[0];
      console.log('Selected file:', inputFile?.name);
    });

    convertBtn.addEventListener('click', async () => {
      if (!inputFile) {
        alert('Please select a file.');
        return;
      }

      const outputFormat = outputFormatSelect.value;
      const inputExt = inputFile.name.split('.').pop();
      const inputName = 'input.' + inputExt;
      const outputName = 'output.' + outputFormat;

      try {
        console.log('Loading FFmpeg...');
        await ffmpeg.load();
        console.log('FFmpeg loaded.');

        const data = await inputFile.arrayBuffer();
        ffmpeg.FS('writeFile', inputName, new Uint8Array(data));
        console.log('Input file written to FS.');

        console.log(`Running FFmpeg: -i ${inputName} ${outputName}`);
        await ffmpeg.run('-i', inputName, outputName);
        console.log('Conversion complete.');

        const outputData = ffmpeg.FS('readFile', outputName);
        const blob = new Blob([outputData.buffer], {
          type: outputFormat === 'gif' ? 'image/gif' : 'video/' + outputFormat,
        });
        videoOutput.src = URL.createObjectURL(blob);
        console.log('Output video ready.');
      } catch (err) {
        console.error('Conversion failed:', err);
      }
    });
  </script>
</body>
</html>
