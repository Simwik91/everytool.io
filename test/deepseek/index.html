<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Video Converter</title>
    <style>
        /* [Previous CSS styles remain exactly the same] */
    </style>
</head>
<body>
    <div class="container">
        <!-- [Previous HTML structure remains exactly the same] -->
    </div>

    <!-- Load FFmpeg scripts with proper error handling -->
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>
    <script>
        // Wait for all scripts to load
        window.addEventListener('load', async function() {
            // Check if FFmpeg is available
            if (typeof FFmpeg === 'undefined') {
                showError('FFmpeg library failed to load. Please refresh the page or check your internet connection.');
                return;
            }

            // DOM elements [same as previous version]
            const fileInput = document.getElementById('file-input');
            const dropArea = document.getElementById('drop-area');
            // [All other DOM element declarations remain the same]

            // Variables
            let selectedFile = null;
            let ffmpeg = null;

            // Initialize FFmpeg with retry logic
            async function initializeFFmpeg() {
                statusMessage.textContent = 'Loading FFmpeg (this may take a moment)...';
                statusMessage.className = 'status-message status-info';
                statusMessage.style.display = 'block';
                
                try {
                    // Retry mechanism
                    let retries = 3;
                    while (retries > 0) {
                        try {
                            const { createFFmpeg, fetchFile } = FFmpeg;
                            ffmpeg = createFFmpeg({ 
                                log: true,
                                corePath: 'https://unpkg.com/@ffmpeg/core@0.12.4/dist/ffmpeg-core.js'
                            });
                            
                            await ffmpeg.load();
                            break;
                        } catch (error) {
                            retries--;
                            if (retries === 0) throw error;
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                    
                    statusMessage.textContent = 'FFmpeg loaded successfully!';
                    setTimeout(() => {
                        statusMessage.style.display = 'none';
                    }, 3000);
                } catch (error) {
                    console.error('FFmpeg initialization error:', error);
                    showError(`Failed to initialize FFmpeg: ${error.message}`);
                    convertBtn.disabled = true;
                }
            }

            // [All other functions remain the same as previous version]

            // Initialize the converter
            initializeFFmpeg();
        });

        // Show error message (defined outside DOMContentLoaded to be available immediately)
        function showError(message) {
            const statusEl = document.getElementById('status-message');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = 'status-message status-error';
                statusEl.style.display = 'block';
                
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 5000);
            } else {
                alert(message);
            }
        }
    </script>
</body>
</html>
