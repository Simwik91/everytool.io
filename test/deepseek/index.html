<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Video Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .upload-area {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #f0f0f0;
        }
        .debug-info {
            font-family: monospace;
            background: #333;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Browser Video Converter</h1>
    <div id="status">Initializing...</div>
    <div id="debug" class="debug-info"></div>

    <script>
        // Debug logging
        const debugEl = document.getElementById('debug');
        function debugLog(message) {
            debugEl.innerHTML += `> ${message}\n`;
            debugEl.scrollTop = debugEl.scrollHeight;
        }

        // CDN sources to try (ordered by reliability)
        const CDN_SOURCES = [
            {
                name: "jsDelivr (primary)",
                ffmpegUrl: "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js",
                coreUrl: "https://cdn.jsdelivr.net/npm/@ffmpeg/core@0.12.4/dist/ffmpeg-core.js"
            },
            {
                name: "unpkg (fallback 1)",
                ffmpegUrl: "https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js",
                coreUrl: "https://unpkg.com/@ffmpeg/core@0.12.4/dist/ffmpeg-core.js"
            },
            {
                name: "cdnjs (fallback 2)",
                ffmpegUrl: "https://cdnjs.cloudflare.com/ajax/libs/ffmpeg.js/0.12.4/ffmpeg.min.js",
                coreUrl: "https://cdnjs.cloudflare.com/ajax/libs/ffmpeg.js/0.12.4/ffmpeg-core.js"
            },
            {
                name: "GitHub (last resort)",
                ffmpegUrl: "https://raw.githubusercontent.com/ffmpegwasm/ffmpeg.wasm/main/dist/ffmpeg.min.js",
                coreUrl: "https://raw.githubusercontent.com/ffmpegwasm/ffmpeg.wasm/main/dist/ffmpeg-core.js"
            }
        ];

        // Current CDN being tried
        let currentCdnIndex = 0;
        let ffmpeg = null;

        // Update status
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            debugLog(message);
        }

        // Load script with timeout
        function loadScript(src, timeout = 10000) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                
                const timer = setTimeout(() => {
                    reject(new Error(`Timeout loading ${src}`));
                    document.head.removeChild(script);
                }, timeout);

                script.onload = () => {
                    clearTimeout(timer);
                    resolve();
                };
                
                script.onerror = () => {
                    clearTimeout(timer);
                    reject(new Error(`Failed to load ${src}`));
                };
                
                document.head.appendChild(script);
            });
        }

        // Try loading FFmpeg from current CDN
        async function tryLoadFfmpeg() {
            if (currentCdnIndex >= CDN_SOURCES.length) {
                throw new Error("All CDN sources failed");
            }

            const cdn = CDN_SOURCES[currentCdnIndex];
            updateStatus(`Trying ${cdn.name} (${cdn.ffmpegUrl})`);
            
            try {
                // Load main FFmpeg library
                await loadScript(cdn.ffmpegUrl);
                
                if (typeof FFmpeg === 'undefined') {
                    throw new Error("FFmpeg not defined after loading");
                }

                // Initialize FFmpeg
                const { createFFmpeg } = FFmpeg;
                ffmpeg = createFFmpeg({
                    log: true,
                    corePath: cdn.coreUrl
                });

                updateStatus(`Loading FFmpeg core from ${cdn.coreUrl}`);
                await ffmpeg.load();
                
                updateStatus(`Success! Using ${cdn.name}`);
                return true;
            } catch (error) {
                debugLog(`Error: ${error.message}`);
                currentCdnIndex++;
                return false;
            }
        }

        // Main initialization
        async function initialize() {
            updateStatus("Starting FFmpeg initialization...");
            
            // Try each CDN until one works
            while (currentCdnIndex < CDN_SOURCES.length) {
                const success = await tryLoadFfmpeg();
                if (success) {
                    updateStatus("FFmpeg loaded successfully!");
                    startApplication();
                    return;
                }
            }
            
            updateStatus("All CDN sources failed. Please check your internet connection.");
        }

        // Application code after FFmpeg loads
        function startApplication() {
            updateStatus("Application ready!");
            // Your application code here
        }

        // Start the process
        initialize();
    </script>
</body>
</html>
